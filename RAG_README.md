# Deep Dive! 지능형 블로그 RAG 프로젝트
> **"단순한 검색을 넘어, 맥락을 이해하고 대화하는 AI 기술 블로그"**

## 1. 프로젝트 소개
이 문서는 **Deep Dive! 블로그**에 도입된 **RAG (Retrieval-Augmented Generation)** 기반 챗봇 시스템의 설계와 구현 과정을 다룹니다.

기존의 키워드 검색 만으로는 해결할 수 없었던 "구체적인 질문에 대한 답변"과 "대화형 탐색"을 제공하기 위해, **Amazon Bedrock (Claude 3)** 과 **OpenSearch** 를 활용하여 블로그의 모든 글을 학습시켰습니다. 또한, **서버리스 아키텍처**와 **이벤트 기반 파이프라인**을 통해 운영 비용을 최소화하면서도 고성능의 RAG 시스템을 구축했습니다.

---

## 2. RAG 시스템 아키텍처
데이터의 생성부터 사용자 답변까지 이어지는 전체 파이프라인은 **이벤트 기반(Event-Driven)** 으로 동작하며, 크게 '지식 데이터 준비(Indexing)'와 '질문 답변(Service)' 단계로 나뉩니다.

### 핵심 아키텍처 포인트
- **자동화된 파이프라인**: 글 작성 시 DynamoDB Stream이 변경을 감지하고, 비동기 Lambda가 즉시 벡터 임베딩을 수행합니다.
- **비용 효율성**: 전용 벡터 DB 대신, 기존에 사용 중이던 **OpenSearch**에 k-NN 플러그인을 적용하여 추가 비용 없이 벡터 검색을 구현했습니다.
- **맥락 인식**: 단순 검색이 아닌, 이전 대화 기록(History)을 분석하여 모호한 질문("그거 알려줘")도 정확히 처리합니다.

---

## 3. 핵심 기능 및 주요 기술

### 3.1. 이벤트 기반 실시간 인덱싱 (Real-time Indexing)
> **"글을 쓰는 순간, AI의 지식이 된다"**

<!-- 1. 스크린샷 : 인덱싱 데이터 파이프라인 아키텍처 (DynamoDB -> Stream -> Lambda -> Bedrock -> OpenSearch 흐름도) -->

- **Process**: `DynamoDB Save -> Stream -> Trigger -> Chunking -> Embedding -> OpenSearch`
- **청킹 전략**: 단순히 글자 수로 자르지 않고, 마크다운의 헤더(`#`)와 문단을 기준으로 의미 단위로 쪼개어 검색 정확도를 높였습니다.
- **Titan Embeddings v2**: AWS의 경량화된 임베딩 모델을 사용하여 저비용으로 고품질의 벡터 데이터를 생성합니다.

### 3.2. 맥락 인식 검색 (Context-Aware RAG)
> **"대화의 흐름을 기억하는 RAG 답변"**

<!-- 2. 스크린샷 : RAG 질문/답변 서비스 아키텍처 (User -> Chat API -> Text/Vector Hybrid Search -> Claude 3 -> Response) -->

- **Query Expansion**: 사용자의 질문이 "그거", "이거"와 같은 대명사를 포함할 경우, 이전 대화 맥락을 바탕으로 완전한 질문으로 재구성(Refining)하여 검색합니다.
- **환각(Hallucination) 방지**: 검색 결과의 유사도(Score)가 특정 임계값(0.7) 미만일 경우, 억지로 답변을 생성하지 않고 "관련 내용이 없다"고 솔직하게 답변하여 신뢰성을 확보했습니다.

### 3.3. 하이브리드 채팅 UI & 랜덤 FAQ
> **"기존 채팅과 AI의 조화, 그리고 재미 요소"**

<!-- 추가 스크린샷 : 하이브리드 채팅 위젯 UI (AI 검색 탭과 관리자 문의 탭이 통합된 모습) -->

- **하이브리드 위젯**: 기존의 실시간 채팅 서비스와 새로운 AI 챗봇을 탭(Tab) 형태로 통합하여 하나의 위젯에서 제공합니다.
- **랜덤 FAQ**: 매번 정해진 질문만 보여주는 것이 아니라, 4번째 카드에 **'미스터리 질문'** 기능을 넣어 클릭 시 다양한 주제의 질문을 랜덤하게 추천하여 사용자의 흥미를 유발합니다.

### 3.4. 일일 쿼터 시스템 (Global Quota System)
> **"확실한 비용 방어 전략"**

<!-- 추가 스크린샷 : 쿼터 시스템 UI (채팅창 상단에 남은 질문 횟수 "⚡ 남은 질문: N/50" 표시) -->

- **DynamoDB Atomic Counter**: 동시성 이슈 없이 정확하게 요청 횟수를 카운팅합니다.
- **정책**: 일일 **50회**로 질문 횟수를 제한하여, Bedrock 호출 비용이 월 $1를 넘지 않도록 관리합니다.
- **UX**: 남은 횟수를 채팅창 상단에 실시간으로 표시("⚡ 남은 질문: 42/50")하여, 사용자가 자원을 인지하고 아껴 쓰도록 유도합니다.

---

## 4. 기술 스택

| 분류 | 기술 | 역할 |
|:---:|:---:|---|
| **AI Model** | **Claude 3 Haiku** | 비용 대비 성능이 뛰어난 경량 LLM, 답변 생성 담당 |
| | **Titan Embeddings v2** | 텍스트를 1024차원 벡터로 변환 (Embedding) |
| **Search** | **Amazon OpenSearch** | 텍스트 검색(Match)과 벡터 검색(k-NN)을 결합한 하이브리드 검색 엔진 |
| **Backend** | **AWS Lambda** | 인덱싱 처리 및 채팅 API (Hono 프레임워크) |
| | **DynamoDB Stream** | 데이터 변경 감지 및 이벤트 트리거 |
| **Frontend** | **Next.js / React** | 하이브리드 채팅 위젯 UI 구현 |
| **Infra** | **AWS CDK** | Bedrock 권한 및 OpenSearch 인프라 코드 관리 (IaC) |

---

## 5. 트러블슈팅

### Case 1: 엉뚱한 문서 참조로 인한 답변과 할루시네이션 완화
- **문제**: "커피" 관련 질문 시 관련 없는 글을 참조하여 답변을 지어내는 현상 발생.
- **해결**: OpenSearch 검색 결과의 `_score`를 필터링하는 로직 추가. 유사도가 낮으면 아예 Context에 포함시키지 않도록 하여, AI가 모르는 것은 모른다고 답하게 함.

### Case 2: Bedrock 호출 권한 문제
- **문제**: 배포 후 `Access Denied` 에러 발생.
- **원인**: `IndexingLambda`와 `BackendApiLambda`에 Bedrock Invoke 권한 누락.
- **해결**: CDK에서 `bedrock:InvokeModel` 권한을 특정 모델(`haiku`, `titan`) 리소스에만 한정하여 부여(최소 권한 원칙).


---

## 6. 향후 계획
- **답변 품질 최적화**: 사용자 피드백을 바탕으로 프롬프트를 지속적으로 튜닝.
- **멀티모달 확장**: 텍스트뿐만 아니라 이미지 정보도 검색할 수 있도록 임베딩 모델 확장 검토.
