# 파일 위치: .github/workflows/deploy.yml
# 버전: v2025.08.12-Final-Optimized
# 역할: 각 Job의 책임을 명확히 분리하고, Self-Hosted Runner의 특성을
#       최대한 활용하여 파이프라인을 최종 최적화한 버전

name: "Unified Deploy: CiCd + Blog (Optimized)"

on:
  push:
    branches: [main]
    paths:
      - 'apps/**'
      - 'scripts/**'
      - '.github/workflows/deploy.yml'
      - 'pnpm-lock.yaml'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  ECR_REPOSITORY: new-blog-frontend

jobs:
  # ===================================================================================
  # JOB 1: 변경 감지 (오직 감지만 수행)
  # ===================================================================================
  detect_changes:
    name: "Detect Changed Paths"
    runs-on: ubuntu-latest
    outputs:
      blog: ${{ steps.paths.outputs.blog }}
      cicd: ${{ steps.paths.outputs.cicd }}
    steps:
      - name: "Checkout code"
        uses: actions/checkout@v4

      - name: "Filter changed paths"
        id: paths
        uses: dorny/paths-filter@v3
        with:
          filters: |
            blog:
              - 'apps/frontend/**'
              - 'apps/backend/**'
              - 'apps/infra/lib/blog-stack.ts'
              - 'pnpm-lock.yaml'
            cicd:
              - 'apps/infra/lib/cicd-stack.ts'
              - 'scripts/setup_runner.sh'
  #- '.github/workflows/deploy.yml' 제거 = Runner는 deploy.yml과 무관.

  # ===================================================================================
  # JOB 2: CI/CD 인프라 배포 (오직 CDK 배포만 수행)
  # ===================================================================================
  deploy_cicd_infra:
    name: "Deploy CI/CD Infrastructure (CiCdStack)"
    needs: detect_changes
    if: ${{ needs.detect_changes.outputs.cicd == 'true' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: "Checkout code"
        uses: actions/checkout@v4

      - name: "Setup Node.js & pnpm"
        uses: actions/setup-node@v4
        with:
          node-version: "22"
      - uses: pnpm/action-setup@v4

      # [최종 수정] CDK가 모든 스택을 '합성'하려면 전체 의존성이 필요합니다.
      # 따라서 전체 pnpm install을 다시 수행합니다.
      - name: "Install all dependencies"
        run: pnpm install --frozen-lockfile

      - name: "Configure AWS Credentials"
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      # [최종 수정] 'deploy' 명령어는 특정 스택만 배포하도록 명확히 지정합니다.
      # CDK는 내부적으로 모든 스택을 합성하지만, CloudFormation에는 CiCdStack만 전달합니다.
      - name: "Deploy CiCdStack via CDK"
        run: pnpm --filter infra exec cdk deploy CiCdStack --require-approval never

  # ===================================================================================
  # JOB 3: 블로그 애플리케이션 배포 (Self-Hosted Runner에서 모든 작업을 수행)
  # ===================================================================================
  deploy_blog_app:
    name: "Build and Deploy Blog Application"
    needs: [detect_changes, deploy_cicd_infra]
    runs-on: self-hosted
    permissions:
      id-token: write
      contents: read
      packages: write
    if: |
      always() &&
      (needs.detect_changes.outputs.blog == 'true' || github.event_name == 'workflow_dispatch')
    steps:
      - name: "Checkout code"
        uses: actions/checkout@v4

      - name: "Setup Node.js & pnpm"
        uses: actions/setup-node@v4
        with:
          node-version: "22"
      - uses: pnpm/action-setup@v4

      - name: "Install dependencies"
        run: pnpm install --frozen-lockfile

      # [핵심 수정 1] Turborepo 빌드를 먼저 실행하여, 로컬 디스크에 .turbo 캐시를 생성합니다.
      - name: "Build Applications with Turborepo to create cache"
        run: pnpm --filter frontend --filter backend run build

      - name: "Configure AWS Credentials (from EC2 Role)"
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}

      - name: "Login to Amazon ECR"
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: "Define Image Tag"
        id: image-def
        run: echo "TAG=$(date +%Ym%d%H%M%S)-$(echo $GITHUB_SHA | cut -c1-7)" >> $GITHUB_OUTPUT

      # [핵심 수정 2] Docker 빌드에 ECR 레지스트리 캐시를 활성화합니다.
      - name: "Build and push Docker image with cache"
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/frontend/Dockerfile
          push: true
          tags: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ steps.image-def.outputs.TAG }}
          platforms: linux/arm64
          provenance: false
          # ECR을 Docker 레이어 캐시 저장소로 사용합니다.
          cache-from: type=registry,ref=${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:cache
          cache-to: type=registry,ref=${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:cache,mode=max

      # ... 이하 Deploy, Sync, Invalidate 스텝은 변경 없음 ...
      - name: "Deploy Blog Infrastructure (BlogInfraStack)"
        run: |
          pnpm --filter infra exec cdk deploy BlogInfraStack \
            --require-approval never \
            --outputs-file "${{ github.workspace }}/apps/infra/outputs.json" \
            --parameters ImageTag=${{ steps.image-def.outputs.TAG }}

      - name: "Sync Static Assets to S3"
        run: |
          set -euo pipefail
          ASSET_JSON_PATH="${{ github.workspace }}/apps/infra/outputs.json"
          if [ ! -f "$ASSET_JSON_PATH" ]; then
            echo "::error::CDK output file not found at $ASSET_JSON_PATH"
            exit 1
          fi
          ASSET_BUCKET_NAME=$(node -p "require('$ASSET_JSON_PATH').BlogInfraStack.FrontendAssetsBucketName")
          echo "Syncing ./apps/frontend/.next/static -> s3://${ASSET_BUCKET_NAME}/_next/static"
          aws s3 sync ./apps/frontend/.next/static s3://${ASSET_BUCKET_NAME}/_next/static --delete

      - name: "Invalidate CloudFront Cache"
        run: |
          set -euo pipefail
          ASSET_JSON_PATH="${{ github.workspace }}/apps/infra/outputs.json"
          if [ ! -f "$ASSET_JSON_PATH" ]; then
            echo "::error::CDK output file not found at $ASSET_JSON_PATH"
            exit 1
          fi
          DISTRIBUTION_ID=$(node -p "require('$ASSET_JSON_PATH').BlogInfraStack.CloudFrontDistributionId")
          echo "Creating CloudFront invalidation for distribution ${DISTRIBUTION_ID}"
          aws cloudfront create-invalidation --distribution-id ${DISTRIBUTION_ID} --paths "/*"