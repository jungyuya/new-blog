name: Infra CD (Deploy AWS CDK)

on:
  push:
    branches:
      - main
    paths:
      - 'apps/infra/**' # apps/infra 디렉토리 내의 파일 변경 시 트리거
      - 'pnpm-workspace.yaml' # 워크스페이스 설정 파일 변경 시 트리거
      - 'pnpm-lock.yaml' # 의존성 파일 변경 시 트리거
  workflow_run: # backend-ci.yml 워크플로우가 성공적으로 완료되면 트리거
    workflows: ["Backend CI (Build & Upload Lambda Artifact)"] # backend-ci.yml의 name
    types:
      - completed
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write # OIDC 토큰을 요청할 권한
      contents: read # 리포지토리 내용을 읽을 권한

    env: # 이 env 블록은 job 아래에 2칸 들여쓰기 되어야 합니다.
      AWS_REGION: ap-northeast-2 # 여러분의 AWS 리전으로 변경 (예: ap-northeast-2)
      ARTIFACT_BUCKET_NAME_BASE: blog-lambda-artifacts-${{ secrets.AWS_ACCOUNT_ID }} # S3 아티팩트 버킷 이름의 기본 부분

    # push 이벤트이거나, workflow_run 이벤트가 'success'로 완료되었을 때만 deploy Job 실행
    if: github.event_name == 'push' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # workflow_run을 트리거한 워크플로우의 커밋 SHA를 참조하여 정확한 코드 버전을 가져옵니다.
          # push 이벤트인 경우 기본적으로 현재 커밋을 가져옵니다.
          ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || github.sha }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9 # ⭐ 로컬 pnpm 버전(9.x.x)과 동일하게 9로 명시
          run_install: false # pnpm install은 다음 단계에서 실행

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm' # pnpm 캐시 사용

      - name: Install dependencies
        run: pnpm install --frozen-lockfile # pnpm-lock.yaml에 고정된 버전으로 설치

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/GitHubActionsCDKDeployRole # 4.2에서 생성한 IAM 역할 ARN
          aws-region: ${{ env.AWS_REGION }} # AWS_REGION 환경 변수 참조

      - name: Install AWS CDK CLI
        run: npm install -g aws-cdk # CDK CLI 설치 (runner에 없을 수 있으므로)

      - name: CDK Diff (Optional but Recommended for Review)
        run: pnpm --filter infra cdk diff # Turborepo 필터로 infra 워크스페이스에 대해 cdk diff 실행
        working-directory: ./apps/infra # apps/infra 디렉토리에서 스크립트 실행

      - name: CDK Deploy Infrastructure (with forced logging)
        # ⭐ 핵심 변경: cdk deploy 출력을 파일로 리다이렉션 후 강제 출력
        run: |
          set -euxo pipefail # 여전히 오류 발생 시 즉시 종료
          DEPLOY_LOG_FILE="cdk_deploy_output.log" # 임시 로그 파일명
          
          # pnpm cdk deploy 실행, 모든 출력 (stdout, stderr)을 파일로 리다이렉션
          # 성공하면 0, 실패하면 1을 반환하도록 pipefail 적용
          pnpm --filter infra cdk deploy --require-approval never --outputs-file cdk-outputs.json > "${DEPLOY_LOG_FILE}" 2>&1 || true # 실패 시에도 즉시 종료하지 않고 로그 파일에 남김
          
          # 로그 파일 내용을 출력하여 GitHub Actions 로그에 포함
          echo "--- CDK Deploy Output ---"
          cat "${DEPLOY_LOG_FILE}"
          echo "-------------------------"

          # cdk deploy 명령의 실제 종료 코드를 확인하여 스텝 실패 여부 결정
          if grep -q "deployed" "${DEPLOY_LOG_FILE}"; then
            echo "CDK deploy command completed successfully."
          elif grep -q "No changes to deploy" "${DEPLOY_LOG_FILE}"; then
            echo "CDK deploy command completed with no changes to deploy."
          else
            echo "CDK deploy command failed. Check the output above for errors."
            exit 1 # 실제 오류가 있었다면 스텝 실패 처리
          fi
        working-directory: ./apps/infra
        env:
          GITHUB_SHA: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || github.sha }}
          ARTIFACT_BUCKET_NAME: ${{ env.ARTIFACT_BUCKET_NAME_BASE }}-${{ env.AWS_REGION }}

      - name: Save CDK Outputs
        uses: actions/upload-artifact@v4
        with:
          name: cdk-outputs
          path: apps/infra/cdk-outputs.json
          if-no-files-found: warn
          compression-level: 6
          overwrite: false
          include-hidden-files: false