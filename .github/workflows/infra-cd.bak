# .github/workflows/infra-cd.bak => deploy-backend.yml로 통합됨
name: Infra CD (Deploy AWS CDK)

on:
  workflow_run:
    workflows: ["Backend CI (Build & Test Backend Code)"]
    types:
      - completed
    branches:
      - main

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    env:
      AWS_REGION: ap-northeast-2
      CDK_DEFAULT_ACCOUNT: ${{ secrets.AWS_ACCOUNT_ID }}
      # ⭐ 핵심 수정: CDK_DEFAULT_REGION 값을 'ap-northeast-2'로 직접 지정합니다. ⭐
      CDK_DEFAULT_REGION: ap-northeast-2 

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install Monorepo Dependencies
        run: pnpm install --frozen-lockfile
            
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/GitHubActionsCDKDeployRole
          aws-region: ${{ env.AWS_REGION }} # 이 위치에서는 ${{ env.AWS_REGION }}이 올바르게 작동합니다.

      - name: CDK Deploy Infrastructure
        working-directory: ./apps/infra
        run: pnpm exec cdk deploy --require-approval never